{% extends 'base.html' %}

{% block title %}Calendario DD - ITICO{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mb-6">
    <ol class="flex items-center space-x-2 text-sm">
        <li class="flex items-center">
            <a href="{% url 'dashboard:index' %}" class="text-gray-500 hover:text-gray-700 transition-colors duration-200">
                <i class="fas fa-home"></i>
            </a>
        </li>
        <li class="flex items-center">
            <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
            <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-gradient-to-r from-orange-500 to-red-600 text-white mr-2">
                <i class="fas fa-calendar-alt text-sm"></i>
            </div>
            <span class="font-semibold text-gray-800">Calendario DD</span>
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Header Section -->
<div class="mb-8">
    <div class="bg-gradient-to-r from-orange-600 to-red-600 rounded-2xl p-8 text-white shadow-2xl relative overflow-hidden">
        <div class="absolute inset-0 bg-black bg-opacity-10"></div>
        <div class="absolute -top-4 -right-4 w-24 h-24 bg-white bg-opacity-10 rounded-full"></div>
        <div class="absolute -bottom-8 -left-8 w-32 h-32 bg-white bg-opacity-5 rounded-full"></div>
        
        <div class="relative z-10">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                <div class="mb-6 lg:mb-0">
                    <h1 class="text-3xl lg:text-4xl font-bold mb-3 flex items-center text-white">
                        <div class="w-12 h-12 rounded-xl bg-white bg-opacity-20 flex items-center justify-center mr-4 backdrop-blur-sm">
                            <i class="fas fa-calendar-alt text-white"></i>
                        </div>
                        Calendario de Vencimientos
                    </h1>
                    <p class="text-lg text-white leading-relaxed">
                        Seguimiento de debidas diligencias y documentos por vencer
                        <br>
                        <span class="text-sm opacity-90 text-white">Gestión proactiva de fechas críticas</span>
                    </p>
                </div>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="refresh-calendar" class="bg-white bg-opacity-20 text-white px-6 py-3 rounded-xl font-semibold hover:bg-opacity-30 transition-all duration-300 flex items-center justify-center shadow-lg hover:shadow-xl hover:scale-105 backdrop-blur-sm">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Actualizar
                    </button>
                    <button id="export-calendar" class="bg-white bg-opacity-20 text-white px-6 py-3 rounded-xl font-semibold hover:bg-opacity-30 transition-all duration-300 flex items-center justify-center backdrop-blur-sm">
                        <i class="fas fa-download mr-2"></i>
                        Exportar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content: Calendar and Sidebar -->
<div class="grid grid-cols-1 lg:grid-cols-4 gap-8 mb-8">
    <!-- Calendar Section -->
    <div class="lg:col-span-3">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <!-- Calendar Header -->
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-calendar mr-3 text-orange-600"></i>
                        <span id="current-month-year">Enero 2025</span>
                    </h2>
                    <div class="flex items-center space-x-3">
                        <button id="prev-month" class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors duration-200">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button id="today-btn" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors duration-200 text-sm font-medium">
                            Hoy
                        </button>
                        <button id="next-month" class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors duration-200">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Calendar Grid -->
            <div class="p-6">
                <!-- Calendar View Toggle -->
                <div class="mb-6 flex justify-center">
                    <div class="bg-gray-100 p-1 rounded-lg flex">
                        <button id="month-view" class="calendar-view-btn active px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200">
                            Mes
                        </button>
                        <button id="week-view" class="calendar-view-btn px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200">
                            Semana
                        </button>
                        <button id="agenda-view" class="calendar-view-btn px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200">
                            Agenda
                        </button>
                    </div>
                </div>
                
                <!-- Calendar Container -->
                <div id="calendar-container">
                    <!-- Days of Week Header -->
                    <div class="grid grid-cols-7 gap-2 mb-4">
                        <div class="text-center text-sm font-semibold text-gray-600 py-2">Dom</div>
                        <div class="text-center text-sm font-semibold text-gray-600 py-2">Lun</div>
                        <div class="text-center text-sm font-semibold text-gray-600 py-2">Mar</div>
                        <div class="text-center text-sm font-semibold text-gray-600 py-2">Mié</div>
                        <div class="text-center text-sm font-semibold text-gray-600 py-2">Jue</div>
                        <div class="text-center text-sm font-semibold text-gray-600 py-2">Vie</div>
                        <div class="text-center text-sm font-semibold text-gray-600 py-2">Sáb</div>
                    </div>
                    
                    <!-- Calendar Days Grid -->
                    <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                        <!-- Days will be generated by JavaScript -->
                    </div>
                </div>
                
                <!-- Agenda View (Hidden by default) -->
                <div id="agenda-container" class="hidden">
                    <div id="agenda-list" class="space-y-4">
                        <!-- Agenda items will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Filters -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-filter mr-3 text-blue-600"></i>
                    Filtros
                </h3>
            </div>
            <div class="p-6 space-y-4">
                <!-- Event Type Filter -->
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">Tipo de Evento</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="filter-dd" class="event-filter rounded text-orange-600 focus:ring-orange-500" checked>
                            <span class="ml-2 text-sm text-gray-700">Debidas Diligencias</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="filter-docs" class="event-filter rounded text-red-600 focus:ring-red-500" checked>
                            <span class="ml-2 text-sm text-gray-700">Documentos</span>
                        </label>
                    </div>
                </div>
                
                <!-- Priority Filter -->
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">Prioridad</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="filter-critical" class="priority-filter rounded text-red-600 focus:ring-red-500" checked>
                            <span class="ml-2 text-sm text-gray-700">Crítico (0-7 días)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="filter-high" class="priority-filter rounded text-yellow-600 focus:ring-yellow-500" checked>
                            <span class="ml-2 text-sm text-gray-700">Alto (8-30 días)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="filter-medium" class="priority-filter rounded text-green-600 focus:ring-green-500" checked>
                            <span class="ml-2 text-sm text-gray-700">Medio (31-90 días)</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming Events -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-clock mr-3 text-red-600"></i>
                    Próximos Vencimientos
                </h3>
            </div>
            <div class="p-6">
                <div id="upcoming-events" class="space-y-3">
                    <!-- Upcoming events will be populated by JavaScript -->
                {% for event in events %}
                    {% if event.days_until <= 7 %}
                        <div class="flex items-center p-3 bg-{% if event.priority == 'critical' %}red{% elif event.priority == 'high' %}yellow{% else %}green{% endif %}-50 border border-{% if event.priority == 'critical' %}red{% elif event.priority == 'high' %}yellow{% else %}green{% endif %}-200 rounded-lg cursor-pointer hover:shadow-md transition-shadow duration-200" onclick="showEventDetails('{{ event.id }}')">
                            <div class="flex-shrink-0 w-3 h-3 bg-{% if event.priority == 'critical' %}red{% elif event.priority == 'high' %}yellow{% else %}green{% endif %}-500 rounded-full mr-3"></div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-{% if event.priority == 'critical' %}red{% elif event.priority == 'high' %}yellow{% else %}green{% endif %}-800">{{ event.title }}</p>
                                <p class="text-xs text-{% if event.priority == 'critical' %}red{% elif event.priority == 'high' %}yellow{% else %}green{% endif %}-600">
                                    {% if event.days_until == 0 %}
                                        Vence hoy
                                    {% elif event.days_until == 1 %}
                                        Vence mañana
                                    {% else %}
                                        Vence en {{ event.days_until }} días
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    {% endif %}
                {% empty %}
                    <p class="text-sm text-gray-500 text-center py-4">No hay eventos próximos</p>
                {% endfor %}
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-chart-bar mr-3 text-green-600"></i>
                    Estadísticas
                </h3>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Este mes</span>
                    <span class="text-lg font-bold text-gray-900" id="stats-this-month">{{ stats.this_month }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Próximos 30 días</span>
                    <span class="text-lg font-bold text-orange-600" id="stats-next-month">{{ stats.next_30_days }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Críticos (≤7 días)</span>
                    <span class="text-lg font-bold text-red-600" id="stats-critical">{{ stats.critical_events }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Total eventos</span>
                    <span class="text-lg font-bold text-blue-600" id="stats-total">{{ stats.total_events }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Table Section - Full Width -->
<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
    <!-- Table Header -->
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-list mr-3 text-orange-600"></i>
                Lista de Vencimientos Próximos
            </h2>
            <div class="flex items-center space-x-3">
                <div class="flex items-center space-x-2">
                    <label for="table-filter" class="text-sm font-medium text-gray-600">Filtrar:</label>
                    <select id="table-filter" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <option value="all">Todos</option>
                        <option value="dd">Solo DD</option>
                        <option value="document">Solo Documentos</option>
                        <option value="critical">Solo Críticos</option>
                        <option value="upcoming">Próximos 30 días</option>
                    </select>
                </div>
                <button id="export-table" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors duration-200 text-sm font-medium">
                    <i class="fas fa-download mr-2"></i>
                    Exportar
                </button>
            </div>
        </div>
    </div>
        
        <!-- Table Content -->
        <div class="overflow-x-auto">
            <table id="vencimientos-table" class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Tipo
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Contraparte
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Descripción
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Fecha de Vencimiento
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Días Restantes
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Prioridad
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Acciones
                        </th>
                    </tr>
                </thead>
                <tbody id="vencimientos-tbody" class="bg-white divide-y divide-gray-200">
                    {% for event in events %}
                    <tr class="hover:bg-gray-50 transition-colors duration-200 event-row" 
                        data-type="{{ event.type }}" 
                        data-priority="{{ event.priority }}" 
                        data-days="{{ event.days_until }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                {% if event.type == 'dd' %}
                                    <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-shield-alt text-blue-600 text-sm"></i>
                                    </div>
                                    <div class="ml-3">
                                        <div class="text-sm font-medium text-gray-900">Debida Diligencia</div>
                                    </div>
                                {% else %}
                                    <div class="flex-shrink-0 w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-file-alt text-green-600 text-sm"></i>
                                    </div>
                                    <div class="ml-3">
                                        <div class="text-sm font-medium text-gray-900">Documento</div>
                                        {% if event.document_type %}
                                        <div class="text-xs text-gray-500">{{ event.document_type }}</div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ event.contraparte }}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">{{ event.title }}</div>
                            <div class="text-xs text-gray-500">{{ event.description|truncatechars:80 }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ event.date|date:"d M Y" }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                {% if event.days_until < 0 %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        <i class="fas fa-exclamation-circle mr-1"></i>
                                        Vencido
                                    </span>
                                {% elif event.days_until == 0 %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        <i class="fas fa-clock mr-1"></i>
                                        Hoy
                                    </span>
                                {% elif event.days_until <= 7 %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        {{ event.days_until }} día{{ event.days_until|pluralize }}
                                    </span>
                                {% elif event.days_until <= 30 %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        <i class="fas fa-clock mr-1"></i>
                                        {{ event.days_until }} días
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <i class="fas fa-calendar mr-1"></i>
                                        {{ event.days_until }} días
                                    </span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if event.priority == 'critical' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    <span class="w-2 h-2 bg-red-500 rounded-full mr-1"></span>
                                    Crítico
                                </span>
                            {% elif event.priority == 'high' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    <span class="w-2 h-2 bg-yellow-500 rounded-full mr-1"></span>
                                    Alto
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                                    Medio
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center space-x-2">
                                <a href="/contrapartes/detalle/{{ event.contraparte_id }}/" 
                                   class="text-orange-600 hover:text-orange-900 transition-colors duration-200"
                                   title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if event.type == 'dd' %}
                                    <button onclick="iniciarDD({{ event.contraparte_id }})" 
                                            class="text-blue-600 hover:text-blue-900 transition-colors duration-200"
                                            title="Iniciar DD">
                                        <i class="fas fa-play"></i>
                                    </button>
                                {% else %}
                                    <button onclick="renovarDocumento({{ event.contraparte_id }}, '{{ event.document_type|escapejs }}')" 
                                            class="text-green-600 hover:text-green-900 transition-colors duration-200"
                                            title="Renovar documento">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                {% endif %}
                                <button onclick="enviarRecordatorio({{ event.contraparte_id }}, '{{ event.type }}')" 
                                        class="text-purple-600 hover:text-purple-900 transition-colors duration-200"
                                        title="Enviar recordatorio">
                                    <i class="fas fa-bell"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center justify-center">
                                <i class="fas fa-calendar-check text-gray-400 text-4xl mb-4"></i>
                                <p class="text-gray-500 text-lg font-medium">No hay vencimientos próximos</p>
                                <p class="text-gray-400 text-sm">Todas las debidas diligencias y documentos están al día</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Table Footer with Pagination -->
        <div class="px-6 py-3 bg-gray-50 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    Mostrando <span id="showing-count">{{ events|length }}</span> de <span id="total-count">{{ events|length }}</span> elementos
                </div>
                <div class="flex items-center space-x-2">
                    <button id="prev-page" class="px-3 py-1 text-sm text-gray-600 hover:text-gray-800 disabled:opacity-50" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="page-info" class="px-3 py-1 text-sm text-gray-700">Página 1 de 1</span>
                    <button id="next-page" class="px-3 py-1 text-sm text-gray-600 hover:text-gray-800 disabled:opacity-50" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- Event Detail Modal -->
<div id="event-modal" class="fixed inset-0 z-50 hidden">
    <!-- Overlay -->
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"></div>
    
    <!-- Modal Content -->
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative transform overflow-hidden rounded-2xl bg-white shadow-2xl transition-all w-full max-w-lg">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-orange-600 to-red-600 px-6 py-4">
                    <h3 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-calendar-check mr-3"></i>
                        <span id="modal-title">Detalle del Evento</span>
                    </h3>
                </div>
                
                <!-- Modal Body -->
                <div class="px-6 py-6">
                    <div id="modal-content">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="bg-gray-50 px-6 py-4 flex items-center justify-end space-x-3">
                    <button type="button" id="close-modal" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                        Cerrar
                    </button>
                    <button type="button" id="view-details" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors duration-200 flex items-center" onclick="showEventDetails()">
                        <i class="fas fa-external-link-alt mr-2"></i>
                        Ver Detalles
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Calendar functionality
class Calendar {
    constructor() {
        this.currentDate = new Date();
        this.currentView = 'month';
        this.events = [];
        this.init();
    }
    
    init() {
        this.loadEvents();
        this.renderCalendar();
        this.attachEventListeners();
        this.applyFilters();
    }
    
    loadEvents() {
        // Load events from Django context
        this.events = [
            {% for event in events %}
            {
                id: '{{ event.id }}',
                title: '{{ event.title|escapejs }}',
                date: new Date('{{ event.date }}'),
                type: '{{ event.type }}',
                priority: '{{ event.priority }}',
                contraparte: '{{ event.contraparte|escapejs }}',
                contraparte_id: {{ event.contraparte_id }},
                description: '{{ event.description|escapejs }}',
                url: '{{ event.url }}',
                days_until: {{ event.days_until }},
                {% if event.document_type %}document_type: '{{ event.document_type|escapejs }}',{% endif %}
            },
            {% endfor %}
        ];
    }
    
    renderCalendar() {
        this.updateMonthYear();
        
        if (this.currentView === 'month') {
            this.renderMonthView();
        } else if (this.currentView === 'agenda') {
            this.renderAgendaView();
        }
        
        this.renderUpcomingEvents();
        this.updateStatistics();
    }
    
    updateMonthYear() {
        const monthNames = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        
        const monthYear = `${monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
        document.getElementById('current-month-year').textContent = monthYear;
    }
    
    renderMonthView() {
        const calendarGrid = document.getElementById('calendar-grid');
        const calendarContainer = document.getElementById('calendar-container');
        const agendaContainer = document.getElementById('agenda-container');
        
        calendarContainer.classList.remove('hidden');
        agendaContainer.classList.add('hidden');
        
        calendarGrid.innerHTML = '';
        
        const firstDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
        const lastDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        const today = new Date();
        
        for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day min-h-20 p-2 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors duration-200';
            
            const isCurrentMonth = date.getMonth() === this.currentDate.getMonth();
            const isToday = date.toDateString() === today.toDateString();
            
            if (!isCurrentMonth) {
                dayElement.classList.add('text-gray-400', 'bg-gray-50');
            }
            
            if (isToday) {
                dayElement.classList.add('bg-orange-100', 'border-orange-300');
            }
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'text-sm font-semibold mb-1';
            dayNumber.textContent = date.getDate();
            dayElement.appendChild(dayNumber);
            
            // Add events for this day
            const dayEvents = this.getEventsForDate(date);
            dayEvents.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = `text-xs p-1 rounded mb-1 cursor-pointer ${this.getEventClasses(event)}`;
                eventElement.textContent = event.title;
                eventElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.showEventModal(event);
                });
                dayElement.appendChild(eventElement);
            });
            
            calendarGrid.appendChild(dayElement);
        }
    }
    
    renderAgendaView() {
        const calendarContainer = document.getElementById('calendar-container');
        const agendaContainer = document.getElementById('agenda-container');
        const agendaList = document.getElementById('agenda-list');
        
        calendarContainer.classList.add('hidden');
        agendaContainer.classList.remove('hidden');
        
        agendaList.innerHTML = '';
        
        // Sort events by date
        const sortedEvents = [...this.events].sort((a, b) => a.date - b.date);
        
        sortedEvents.forEach(event => {
            const eventElement = document.createElement('div');
            eventElement.className = 'p-4 border border-gray-200 rounded-lg hover:shadow-md transition-shadow duration-200 cursor-pointer';
            eventElement.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-semibold text-gray-900">${event.title}</h4>
                    <span class="text-xs px-2 py-1 rounded-full ${this.getPriorityClasses(event.priority)}">${this.getPriorityText(event.priority)}</span>
                </div>
                <div class="text-sm text-gray-600 mb-1">
                    <i class="fas fa-calendar mr-2"></i>
                    ${event.date.toLocaleDateString('es-ES')}
                </div>
                <div class="text-sm text-gray-600 mb-2">
                    <i class="fas fa-building mr-2"></i>
                    ${event.contraparte}
                </div>
                <p class="text-sm text-gray-700">${event.description}</p>
            `;
            eventElement.addEventListener('click', () => this.showEventModal(event));
            agendaList.appendChild(eventElement);
        });
    }
    
    getEventsForDate(date) {
        return this.events.filter(event => 
            event.date.toDateString() === date.toDateString()
        );
    }
    
    getEventClasses(event) {
        const baseClasses = 'truncate';
        const typeClasses = {
            'dd': 'bg-orange-200 text-orange-800',
            'document': 'bg-red-200 text-red-800'
        };
        
        return `${baseClasses} ${typeClasses[event.type] || 'bg-gray-200 text-gray-800'}`;
    }
    
    getPriorityClasses(priority) {
        const classes = {
            'critical': 'bg-red-100 text-red-800',
            'high': 'bg-yellow-100 text-yellow-800',
            'medium': 'bg-green-100 text-green-800'
        };
        
        return classes[priority] || 'bg-gray-100 text-gray-800';
    }
    
    getPriorityText(priority) {
        const texts = {
            'critical': 'Crítico',
            'high': 'Alto',
            'medium': 'Medio'
        };
        
        return texts[priority] || 'Normal';
    }
    
    renderUpcomingEvents() {
        const upcomingContainer = document.getElementById('upcoming-events');
        const today = new Date();
        const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
        
        const upcomingEvents = this.events
            .filter(event => event.date >= today && event.date <= nextWeek)
            .sort((a, b) => a.date - b.date);
        
        upcomingContainer.innerHTML = '';
        
        if (upcomingEvents.length === 0) {
            upcomingContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No hay eventos próximos</p>';
            return;
        }
        
        upcomingEvents.forEach(event => {
            const daysUntil = Math.ceil((event.date - today) / (1000 * 60 * 60 * 24));
            const eventElement = document.createElement('div');
            eventElement.className = `flex items-center p-3 border rounded-lg cursor-pointer hover:shadow-md transition-shadow duration-200 ${this.getPriorityBorderClasses(event.priority)}`;
            eventElement.innerHTML = `
                <div class="flex-shrink-0 w-3 h-3 rounded-full mr-3 ${this.getPriorityDotClasses(event.priority)}"></div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium ${this.getPriorityTextClasses(event.priority)}">${event.title}</p>
                    <p class="text-xs ${this.getPrioritySubtextClasses(event.priority)}">Vence en ${daysUntil} día${daysUntil !== 1 ? 's' : ''}</p>
                </div>
            `;
            eventElement.addEventListener('click', () => this.showEventModal(event));
            upcomingContainer.appendChild(eventElement);
        });
    }
    
    getPriorityBorderClasses(priority) {
        const classes = {
            'critical': 'bg-red-50 border-red-200',
            'high': 'bg-yellow-50 border-yellow-200',
            'medium': 'bg-green-50 border-green-200'
        };
        
        return classes[priority] || 'bg-gray-50 border-gray-200';
    }
    
    getPriorityDotClasses(priority) {
        const classes = {
            'critical': 'bg-red-500',
            'high': 'bg-yellow-500',
            'medium': 'bg-green-500'
        };
        
        return classes[priority] || 'bg-gray-500';
    }
    
    getPriorityTextClasses(priority) {
        const classes = {
            'critical': 'text-red-800',
            'high': 'text-yellow-800',
            'medium': 'text-green-800'
        };
        
        return classes[priority] || 'text-gray-800';
    }
    
    getPrioritySubtextClasses(priority) {
        const classes = {
            'critical': 'text-red-600',
            'high': 'text-yellow-600',
            'medium': 'text-green-600'
        };
        
        return classes[priority] || 'text-gray-600';
    }
    
    updateStatistics() {
        const today = new Date();
        const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        const next30Days = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
        
        const thisMonth = this.events.filter(event => 
            event.date >= today && event.date <= endOfMonth
        ).length;
        
        const nextMonth = this.events.filter(event => 
            event.date >= today && event.date <= next30Days
        ).length;
        
        const overdue = this.events.filter(event => 
            event.date < today
        ).length;
        
        document.getElementById('stats-this-month').textContent = thisMonth;
        document.getElementById('stats-next-month').textContent = nextMonth;
        document.getElementById('stats-critical').textContent = this.events.filter(e => e.priority === 'critical').length;
        document.getElementById('stats-total').textContent = this.events.length;
    }
    
    showEventModal(event) {
        const modal = document.getElementById('event-modal');
        const title = document.getElementById('modal-title');
        const content = document.getElementById('modal-content');
        
        // Store selected event for view details button
        this.selectedEvent = event;
        
        title.textContent = event.title;
        
        const daysUntil = Math.ceil((event.date - new Date()) / (1000 * 60 * 60 * 24));
        const statusText = daysUntil < 0 ? 'Vencido' : daysUntil === 0 ? 'Vence hoy' : `Vence en ${daysUntil} día${daysUntil !== 1 ? 's' : ''}`;
        
        let additionalInfo = '';
        if (event.type === 'document' && event.document_type) {
            additionalInfo = `
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Tipo de Documento</label>
                    <p class="text-gray-900">${event.document_type}</p>
                </div>
            `;
        }
        
        content.innerHTML = `
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Contraparte</label>
                    <p class="text-gray-900">${event.contraparte}</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Fecha</label>
                    <p class="text-gray-900">${event.date.toLocaleDateString('es-ES')}</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Estado</label>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${this.getPriorityClasses(event.priority)}">
                        ${statusText}
                    </span>
                </div>
                ${additionalInfo}
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Descripción</label>
                    <p class="text-gray-700">${event.description}</p>
                </div>
            </div>
        `;
        
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    hideEventModal() {
        const modal = document.getElementById('event-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
    
    attachEventListeners() {
        // Navigation
        document.getElementById('prev-month').addEventListener('click', () => {
            this.currentDate.setMonth(this.currentDate.getMonth() - 1);
            this.renderCalendar();
        });
        
        document.getElementById('next-month').addEventListener('click', () => {
            this.currentDate.setMonth(this.currentDate.getMonth() + 1);
            this.renderCalendar();
        });
        
        document.getElementById('today-btn').addEventListener('click', () => {
            this.currentDate = new Date();
            this.renderCalendar();
        });
        
        // View toggles
        document.querySelectorAll('.calendar-view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.calendar-view-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                if (btn.id === 'month-view') this.currentView = 'month';
                else if (btn.id === 'agenda-view') this.currentView = 'agenda';
                
                this.renderCalendar();
            });
        });
        
        // Modal
        document.getElementById('close-modal').addEventListener('click', () => this.hideEventModal());
        document.getElementById('event-modal').addEventListener('click', (e) => {
            if (e.target.id === 'event-modal') this.hideEventModal();
        });
        
        // Filters
        document.querySelectorAll('.event-filter, .priority-filter').forEach(filter => {
            filter.addEventListener('change', () => this.applyFilters());
        });
        
        // Refresh
        document.getElementById('refresh-calendar').addEventListener('click', () => {
            this.loadEvents();
            this.renderCalendar();
            this.showNotification('Calendario actualizado', 'success');
        });
    }
    
    applyFilters() {
        // Filter logic would go here
        // For now, just re-render
        this.renderCalendar();
    }
    
    showNotification(message, type = 'info') {
        // Simple notification system
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-x-full`;
        
        if (type === 'success') {
            notification.classList.add('bg-green-500');
        } else if (type === 'error') {
            notification.classList.add('bg-red-500');
        } else {
            notification.classList.add('bg-blue-500');
        }
        
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'} mr-2"></i>
                ${message}
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => notification.classList.remove('translate-x-full'), 100);
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
}

// Table functionality
class VencimientosTable {
    constructor() {
        this.currentPage = 1;
        this.itemsPerPage = 10;
        this.filteredRows = [];
        this.init();
    }
    
    init() {
        this.setupFiltering();
        this.setupPagination();
        this.setupActions();
        this.applyFilter('all');
    }
    
    setupFiltering() {
        const filterSelect = document.getElementById('table-filter');
        if (filterSelect) {
            filterSelect.addEventListener('change', (e) => {
                this.applyFilter(e.target.value);
            });
        }
    }
    
    applyFilter(filterType) {
        const rows = document.querySelectorAll('.event-row');
        this.filteredRows = [];
        
        rows.forEach(row => {
            let show = false;
            const type = row.dataset.type;
            const priority = row.dataset.priority;
            const days = parseInt(row.dataset.days);
            
            switch(filterType) {
                case 'all':
                    show = true;
                    break;
                case 'dd':
                    show = type === 'dd';
                    break;
                case 'document':
                    show = type === 'document';
                    break;
                case 'critical':
                    show = priority === 'critical';
                    break;
                case 'upcoming':
                    show = days <= 30;
                    break;
            }
            
            if (show) {
                this.filteredRows.push(row);
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        this.updateCounts();
        this.currentPage = 1;
        this.updatePagination();
    }
    
    updateCounts() {
        const showingCount = document.getElementById('showing-count');
        const totalCount = document.getElementById('total-count');
        
        if (showingCount) showingCount.textContent = this.filteredRows.length;
        if (totalCount) totalCount.textContent = document.querySelectorAll('.event-row').length;
    }
    
    setupPagination() {
        // For now, disable pagination if there are fewer than itemsPerPage items
        // This is a basic implementation
        this.updatePagination();
    }
    
    updatePagination() {
        const totalPages = Math.ceil(this.filteredRows.length / this.itemsPerPage);
        const pageInfo = document.getElementById('page-info');
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        
        if (pageInfo) {
            pageInfo.textContent = `Página ${this.currentPage} de ${totalPages || 1}`;
        }
        
        if (prevBtn) {
            prevBtn.disabled = this.currentPage <= 1;
        }
        
        if (nextBtn) {
            nextBtn.disabled = this.currentPage >= totalPages;
        }
    }
    
    setupActions() {
        // Export functionality
        const exportBtn = document.getElementById('export-table');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => this.exportTable());
        }
    }
    
    exportTable() {
        // Simple CSV export
        const headers = ['Tipo', 'Contraparte', 'Descripción', 'Fecha Vencimiento', 'Días Restantes', 'Prioridad'];
        let csvContent = headers.join(',') + '\n';
        
        this.filteredRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowData = [];
            
            // Extract text content from specific cells
            rowData.push(cells[0].querySelector('.text-sm.font-medium').textContent.trim()); // Tipo
            rowData.push(cells[1].querySelector('.text-sm.font-medium').textContent.trim()); // Contraparte
            rowData.push(cells[2].querySelector('.text-sm').textContent.trim()); // Descripción
            rowData.push(cells[3].querySelector('.text-sm').textContent.trim()); // Fecha
            rowData.push(cells[4].textContent.trim().replace(/\s+/g, ' ')); // Días
            rowData.push(cells[5].textContent.trim().replace(/\s+/g, ' ')); // Prioridad
            
            csvContent += rowData.map(field => `"${field}"`).join(',') + '\n';
        });
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `vencimientos_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
}

// Global functions for table actions
function iniciarDD(contraparteId) {
    if (confirm('¿Está seguro de que desea iniciar el proceso de Debida Diligencia?')) {
        // Redirect to DD initiation page
        window.location.href = `/debida-diligencia/solicitar/?contraparte=${contraparteId}`;
    }
}

function renovarDocumento(contraparteId, documentType) {
    if (confirm(`¿Desea renovar el documento ${documentType}?`)) {
        // Redirect to document renewal page
        window.location.href = `/contrapartes/detalle/${contraparteId}/#documentos`;
    }
}

function enviarRecordatorio(contraparteId, eventType) {
    if (confirm('¿Desea enviar un recordatorio sobre este vencimiento?')) {
        // Here you would make an AJAX call to send the reminder
        fetch('/notificaciones/enviar-recordatorio/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                contraparte_id: contraparteId,
                event_type: eventType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Recordatorio enviado exitosamente');
            } else {
                alert('Error al enviar recordatorio');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al enviar recordatorio');
        });
    }
}

// CSS for calendar view buttons
const style = document.createElement('style');
style.textContent = `
    .calendar-view-btn {
        background: transparent;
        color: #6B7280;
    }
    
    .calendar-view-btn.active {
        background: #FFFFFF;
        color: #1F2937;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
    
    .calendar-day:hover {
        transform: translateY(-1px);
    }
`;
document.head.appendChild(style);

// Initialize calendar when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    const calendar = new Calendar();
    // Make calendar instance globally available
    window.calendarInstance = calendar;
    
    // Initialize table functionality
    const vencimientosTable = new VencimientosTable();
    window.vencimientosTable = vencimientosTable;
    
    // Setup modal close functionality
    const modal = document.getElementById('event-modal');
    const closeBtn = document.getElementById('close-modal');
    
    closeBtn.addEventListener('click', function() {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    });
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    });
});

// Global function to show event details (used by Ver Detalles button)
function showEventDetails() {
    const calendar = window.calendarInstance;
    if (calendar && calendar.selectedEvent) {
        const event = calendar.selectedEvent;
        // Navigate to the contraparte detail page
        window.location.href = `/contrapartes/detalle/${event.contraparte_id}/`;
    }
}

// Make function globally available
window.showEventDetails = showEventDetails;
</script>
{% endblock %}
