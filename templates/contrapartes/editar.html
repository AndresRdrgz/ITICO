{% extends 'base.html' %}

{% block title %}Editar {{ object.nombre }} - ITICO{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Editar Contraparte</h1>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content - Form -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md p-6">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre</label>
                            <input type="text" name="nombre" value="{{ object.nombre }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nacionalidad</label>
                            <input type="text" name="nacionalidad" value="{{ object.nacionalidad }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                            <select name="tipo" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                {% for tipo in form.tipo.field.queryset %}
                                    <option value="{{ tipo.id }}" {% if object.tipo == tipo %}selected{% endif %}>{{ tipo.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                            <select name="estado" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="activa" {% if object.estado == 'activa' %}selected{% endif %}>Activa</option>
                                <option value="inactiva" {% if object.estado == 'inactiva' %}selected{% endif %}>Inactiva</option>
                                <option value="pendiente" {% if object.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                <option value="rechazada" {% if object.estado == 'rechazada' %}selected{% endif %}>Rechazada</option>
                                <option value="en_revision" {% if object.estado == 'en_revision' %}selected{% endif %}>En Revisión</option>
                            </select>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>
                            <textarea name="descripcion" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{{ object.descripcion }}</textarea>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end space-x-4">
                        <a href="{% url 'contrapartes:detalle' object.pk %}" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-md hover:bg-gray-300">
                            Cancelar
                        </a>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Sidebar - Comments Section -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <div class="w-6 h-6 rounded-lg bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white mr-2">
                            <i class="fas fa-comments text-xs"></i>
                        </div>
                        Comentarios
                        <span id="comentarios-count" class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium">
                            {{ object.comentarios_activos_count }}
                        </span>
                    </h2>
                </div>
                
                <div class="p-6">
                    <!-- Add Comment Form -->
                                        <!-- Add Comment Form -->
                    <form id="comentario-form" class="mb-6">
                        {% csrf_token %}
                        <div class="mb-4">
                            <textarea id="comentario-contenido" 
                                      name="contenido" 
                                      rows="3" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none" 
                                      placeholder="Escriba su comentario aquí..."></textarea>
                        </div>
                        <button type="submit" 
                                class="w-full bg-blue-600 text-white px-4 py-2 rounded-xl font-medium hover:bg-blue-700 transition-colors duration-200 flex items-center justify-center">
                            <i class="fas fa-plus mr-2"></i>
                            Agregar Comentario
                        </button>
                    </form>
                    
                    <!-- Comments List -->
                    <div id="comentarios-container">
                        {% include 'contrapartes/comentarios_list_partial.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Comments -->
<script>
// CSRF token for AJAX requests
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// Add comment
document.getElementById('comentario-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const contenido = document.getElementById('comentario-contenido').value.trim();
    if (!contenido) {
        alert('Por favor escriba un comentario');
        return;
    }
    
    const formData = new FormData();
    formData.append('contenido', contenido);
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    fetch(`{% url 'contrapartes:comentario_crear_ajax' object.pk %}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('comentarios-container').innerHTML = data.comentarios_html;
            document.getElementById('comentario-contenido').value = '';
            document.getElementById('comentarios-count').textContent = data.comentarios_count;
            showMessage(data.message, 'success');
        } else {
            showMessage('Error al agregar comentario', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error al agregar comentario', 'error');
    });
});

// Edit comment
function editarComentario(comentarioId) {
    const comentarioDiv = document.querySelector(`[data-comentario-id="${comentarioId}"]`);
    const contenidoDiv = comentarioDiv.querySelector('.comentario-contenido');
    const editForm = comentarioDiv.querySelector('.comentario-edit-form');
    
    // Get current content for editing
    fetch(`{% url 'contrapartes:comentario_editar_ajax' 0 %}`.replace('0', comentarioId), {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const textarea = editForm.querySelector('textarea');
            textarea.value = data.contenido;
            contenidoDiv.classList.add('hidden');
            editForm.classList.remove('hidden');
        }
    });
}

// Cancel edit
function cancelarEdicion(comentarioId) {
    const comentarioDiv = document.querySelector(`[data-comentario-id="${comentarioId}"]`);
    const contenidoDiv = comentarioDiv.querySelector('.comentario-contenido');
    const editForm = comentarioDiv.querySelector('.comentario-edit-form');
    
    contenidoDiv.classList.remove('hidden');
    editForm.classList.add('hidden');
}

// Save edit
function guardarEdicion(comentarioId) {
    const comentarioDiv = document.querySelector(`[data-comentario-id="${comentarioId}"]`);
    const editForm = comentarioDiv.querySelector('.comentario-edit-form');
    const textarea = editForm.querySelector('textarea');
    
    const formData = new FormData();
    formData.append('contenido', textarea.value);
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    fetch(`{% url 'contrapartes:comentario_editar_ajax' 0 %}`.replace('0', comentarioId), {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('comentarios-container').innerHTML = data.comentarios_html;
            showMessage(data.message, 'success');
        } else {
            showMessage('Error al actualizar comentario', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error al actualizar comentario', 'error');
    });
}

// Delete comment
function eliminarComentario(comentarioId) {
    if (!confirm('¿Está seguro de que desea eliminar este comentario?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    fetch(`{% url 'contrapartes:comentario_eliminar_ajax' 0 %}`.replace('0', comentarioId), {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('comentarios-container').innerHTML = data.comentarios_html;
            document.getElementById('comentarios-count').textContent = data.comentarios_count;
            showMessage(data.message, 'success');
        } else {
            showMessage('Error al eliminar comentario', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error al eliminar comentario', 'error');
    });
}

// Show message function
function showMessage(message, type) {
    // Create a simple toast notification
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 transition-all duration-300 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}
</script>
{% endblock %}
