<!-- Enhanced JavaScript for ITICO -->
<script>
    // Enhanced Sidebar functionality
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    
    function toggleSidebar() {
        sidebar.classList.toggle('-translate-x-full');
        sidebarOverlay.classList.toggle('hidden');
        document.body.classList.toggle('overflow-hidden');
    }
    
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
    }
    
    if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', toggleSidebar);
    }
    
    // Close sidebar on escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && !sidebar.classList.contains('-translate-x-full')) {
            toggleSidebar();
        }
    });
    
    // Active navigation highlighting
    function setActiveNavLink() {
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('.nav-link');
        
        navLinks.forEach(link => {
            const linkPath = new URL(link.href).pathname;
            if (currentPath.startsWith(linkPath) && linkPath !== '/') {
                link.classList.add('active-nav-link');
                link.style.background = 'rgba(255, 255, 255, 0.15)';
                link.style.transform = 'translateX(4px)';
            }
        });
    }
    
    // Enhanced User menu functionality
    const userMenuButton = document.getElementById('user-menu-button');
    const userMenu = document.getElementById('user-menu');
    const chevronIcon = document.getElementById('chevron-icon');
    
    if (userMenuButton && userMenu) {
        userMenuButton.addEventListener('click', function(e) {
            e.stopPropagation();
            userMenu.classList.toggle('hidden');
            chevronIcon.classList.toggle('fa-chevron-up');
            chevronIcon.classList.toggle('fa-chevron-down');
            
            if (!userMenu.classList.contains('hidden')) {
                userMenu.style.animation = 'slideDown 0.2s ease-out';
            }
        });
        
        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            if (!userMenuButton.contains(event.target) && !userMenu.contains(event.target)) {
                userMenu.classList.add('hidden');
                chevronIcon.classList.remove('fa-chevron-down');
                chevronIcon.classList.add('fa-chevron-up');
            }
        });
    }
    
    // Enhanced notification count update
    function updateNotificationCount() {
        fetch('{% url "notificaciones:api_contar" %}')
            .then(response => response.json())
            .then(data => {
                const badges = document.querySelectorAll('#notification-count, #mobile-notification-count');
                badges.forEach(badge => {
                    if (badge) {
                        badge.textContent = data.count;
                        if (data.count > 0) {
                            badge.style.display = 'flex';
                            badge.classList.add('animate-bounce-gentle');
                        } else {
                            badge.style.display = 'none';
                            badge.classList.remove('animate-bounce-gentle');
                        }
                    }
                });
            })
            .catch(error => console.log('Error updating notifications:', error));
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        setActiveNavLink();
        
        // Auto-hide alerts after 7 seconds with fade out
        setTimeout(() => {
            document.querySelectorAll('.alert-message').forEach(alert => {
                alert.style.transition = 'all 0.5s ease-out';
                alert.style.opacity = '0';
                alert.style.transform = 'translateY(-20px)';
                setTimeout(() => alert.remove(), 500);
            });
        }, 7000);
    });
    
    // Update notifications every 30 seconds if the user is authenticated
    {% if user.is_authenticated %}
        updateNotificationCount();
        setInterval(updateNotificationCount, 30000);
    {% endif %}
    
    // Enhanced confirm dialogs
    document.querySelectorAll('[data-confirm]').forEach(element => {
        element.addEventListener('click', function(e) {
            const message = this.getAttribute('data-confirm');
            if (!confirm(message)) {
                e.preventDefault();
            }
        });
    });
    
    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
    
    // Loading states for buttons
    document.querySelectorAll('button[type="submit"], a.btn').forEach(button => {
        button.addEventListener('click', function() {
            if (!this.classList.contains('disabled') && this.type === 'submit') {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Procesando...';
                this.classList.add('disabled');
                
                // Reset after 10 seconds as fallback
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.classList.remove('disabled');
                }, 10000);
            }
        });
    });
</script>
